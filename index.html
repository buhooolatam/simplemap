<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa con Marcadores</title>
    <style>
        body, html { height: 100%; margin: 0; font-family: Arial, sans-serif; }
        header { background-color: #000; color: #fff; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; }
        header button { background-color: #fff; color: #000; border: none; padding: 8px 16px; cursor: pointer; margin-left: 10px; border-radius: 5px; }
        #map { height: 90vh; width: 100%; }
        .info-window { position: relative; width: 100px; }
        .info-window button { width: 100%; background-color: #007BFF; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; }
        .close-btn { position: absolute; top: 5px; right: 5px; cursor: pointer; color: #888; font-weight: bold; }
    </style>
</head>
<body>
    <header>
        <h1>Buhooo</h1>
        <div>
            <button onclick="goBack()">Atrás</button>
            <button onclick="resetMap()">Resetear</button>
        </div>
    </header>
    <div id="map"></div>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYaUFV_9dHJBxCmJd4GsEYsUs_26Ngq1o&callback=initMap"></script>
    <script>
    let map;

    function initMap() {
        const mapOptions = {
            center: { lat: -17.713042, lng: -63.180106 },
            zoom: 13
        };

        map = new google.maps.Map(document.getElementById('map'), mapOptions);
        map.markers = []; // Inicializa el array de marcadores

        fetch('coor1.json')
            .then(response => response.json())
            .then(data => {
                data.coordinates.forEach((coord, index) => {
                    const markerPosition = { lat: coord[1], lng: coord[0] };
                    const marker = new google.maps.Marker({
                        position: markerPosition,
                        map: map,
                        icon: getMarkerIcon(index, false) // Falso indica no registrado
                    });
                    map.markers.push(marker);

                    marker.addListener('click', function () {
                        openInfoWindow(marker, index);
                    });
                });
                updateMarkers(); // Actualiza colores según localStorage
            })
            .catch(error => console.error('Error al cargar las coordenadas:', error));
    }

    function openInfoWindow(marker, index) {
        const infoWindow = new google.maps.InfoWindow({
            content: `<div class="info-window">
                        <span class="close-btn" onclick="closeInfoWindow()">x</span>
                        <button onclick="registerMarker(${index})">Registrar</button>
                      </div>`
        });

        infoWindow.open(map, marker);
        map.currentInfoWindow = infoWindow;
    }

    function registerMarker(index) {
        const marker = map.markers[index];
        const position = marker.getPosition();
        const coords = `${position.lat()},${position.lng()}`;

        localStorage.setItem(`marker_${index}`, true); // Guarda el estado en localStorage
        marker.setIcon(getMarkerIcon(index, true)); // Verdadero indica registrado

        window.location.href = `https://form1-orpin.vercel.app/?coords=${encodeURIComponent(coords)}`; // Redirección con coordenadas

        closeInfoWindow();
    }

    function updateMarkers() {
        map.markers.forEach((marker, index) => {
            const isRegistered = localStorage.getItem(`marker_${index}`) !== null;
            marker.setIcon(getMarkerIcon(index, isRegistered));
        });
    }

    function getMarkerIcon(index, isRegistered) {
        const color = isRegistered ? "#FF0000" : "#D3D3D3"; // Rojo si registrado, gris si no
        return {
            path: "M12 2C8.13 2 5 5.13 5 9c0 3.25 2.6 5.89 6.24 8.85.37.32.85.32 1.22 0C16.4 14.89 19 12.25 19 9c0-3.87-3.13-7-7-7zm0 11c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z",
            fillColor: color,
            fillOpacity: 1,
            scale: 1.5,
            strokeWeight: 1,
            strokeColor: "#A0A0A0",
            anchor: new google.maps.Point(10, 20)
        };
    }

    function closeInfoWindow() {
        if (map.currentInfoWindow) {
            map.currentInfoWindow.close();
        }
    }

    function resetMap() {
        localStorage.clear();
        updateMarkers();
        alert('Se han reiniciado todos los marcadores.');
    }

    function goBack() {
        alert('Funcionalidad de ir atrás aún no implementada.');
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYaUFV_9dHJBxCmJd4GsEYsUs_26Ngq1o&callback=initMap"></script>
</body>
</html>
