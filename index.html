<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa con Marcadores</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        header {
            background-color: #000;
            color: #fff;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
        }

        header button {
            background-color: #fff;
            color: #000;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            margin-left: 10px;
            border-radius: 5px;
        }

        #map {
            height: 90vh;
            width: 100%;
        }

        .close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            color: #888;
            font-weight: bold;
        }

        .info-window {
            position: relative;
            width: 100px;
        }

        .info-window button {
            width: 100%;
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <header>
        <h1>Buhooo</h1>
        <div>
            <button onclick="goBack()">Atr√°s</button>
            <button onclick="resetMap()">Resetear</button>
        </div>
    </header>
    <div id="map"></div>

    <script>
    let map;

    function initMap() {
        const mapOptions = {
            center: { lat: -17.713042, lng: -63.180106 },
            zoom: 13
        };

        map = new google.maps.Map(document.getElementById('map'), mapOptions);

        // Inicializa el array de marcadores
        map.markers = [];

        const customIcon = {
            path: "M12 2C8.13 2 5 5.13 5 9c0 3.25 2.6 5.89 6.24 8.85.37.32.85.32 1.22 0C16.4 14.89 19 12.25 19 9c0-3.87-3.13-7-7-7zm0 11c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z",
            fillColor: "#D3D3D3",
            fillOpacity: 1,
            scale: 1.5,
            strokeWeight: 1,
            strokeColor: "#A0A0A0",
            anchor: new google.maps.Point(10, 20)
        };

        fetch('coor1.json')
            .then(response => response.json())
            .then(data => {
                data.coordinates.forEach((coord, index) => {
                    const markerPosition = { lat: coord[1], lng: coord[0] };
                    const marker = new google.maps.Marker({
                        position: markerPosition,
                        map: map,
                        icon: customIcon
                    });

                    map.markers.push(marker);

                    marker.addListener('click', function () {
                        openInfoWindow(marker, index);
                    });
                });

                updateMarkers();
            })
            .catch(error => console.error('Error al cargar las coordenadas:', error));
    }

    function openInfoWindow(marker, index) {
        const infoWindow = new google.maps.InfoWindow({
            content: `<div style="text-align: center;">
                        <button class="registerBtn" data-index="${index}" style="margin-top: 10px;">Registrar</button>
                      </div>`
        });

        infoWindow.open(map, marker);
        map.currentInfoWindow = infoWindow;
    }

    // Global event listener for register buttons inside InfoWindows
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('registerBtn')) {
            const index = event.target.getAttribute('data-index');
            registerMarker(index);
        }
    });

    function registerMarker(index) {
        const marker = map.markers[index];
        const position = marker.getPosition();
        const coords = `${position.lat()},${position.lng()}`;
        console.log('Marker registered at coordinates:', coords);
        marker.setIcon({
            ...marker.getIcon(),
            fillColor: "#FF0000"
        });
        map.currentInfoWindow.close();
    }

    function updateMarkers() {
        if (!map.markers) return;
        map.markers.forEach((marker, index) => {
            if (localStorage.getItem(`marker_${index}`)) {
                marker.setIcon({
                    ...marker.getIcon(),
                    fillColor: "#FF0000"
                });
            }
        });
    }

    function resetMap() {
        localStorage.clear();
        updateMarkers();
        alert('All markers have been reset.');
    }

    function goBack() {
        alert('Back functionality not yet implemented.');
    }
</script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYaUFV_9dHJBxCmJd4GsEYsUs_26Ngq1o&callback=initMap"></script>
</body>

</html>
